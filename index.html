<!doctype html>
<html lang="zh-Hant">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ‰“å¡ç³»çµ±</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
Â  body { font-family: system-ui, -apple-system, Segoe UI, Roboto; margin: 0; padding: 24px; background-color: #f8f9fa; }
Â  .wrap { max-width: 420px; margin: 0 auto; text-align: center; background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
Â  h2 { margin-top: 0; color: #333; }
Â  p { color: #666; font-size: 14px; margin-bottom: 24px; }
Â Â 
Â  /* æŒ‰éˆ•å®¹å™¨ï¼šè®“æŒ‰éˆ•ä¸¦æ’ */
Â  .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
Â Â 
Â  button { width: 100%; font-size: 16px; padding: 14px 0; border: 0; border-radius: 12px; cursor: pointer; transition: opacity 0.2s; font-weight: bold; color: #fff; }
Â  button:active { opacity: 0.8; }
Â  button:disabled { background: #ccc !important; cursor: not-allowed; }

Â  /* ä¸åŒé¡è‰²çš„æŒ‰éˆ• */
Â  .btn-in { background: #06C755; } /* LINE ç¶  */
Â  .btn-out { background: #ff9800; } /* æ©˜è‰² */

Â  .msg { margin-top: 20px; line-height: 1.6; font-size: 15px; min-height: 24px; }
</style>

<div class="wrap">
Â  <h2>æ‰“å¡</h2>
Â  <p>è«‹é¸æ“‡æ‰“å¡é¡å‹ï¼Œç³»çµ±å°‡è‡ªå‹•æ“·å–å®šä½ã€‚</p>
Â Â 
Â  <div class="btn-group">
Â  Â  <button id="btnIn" class="btn-in">å¿—å·¥ç°½åˆ°</button>
Â  Â  <button id="btnOut" class="btn-out">å¿—å·¥ç°½é€€</button>
Â  </div>
Â Â 
Â  <div id="msg" class="msg"></div>
</div>

<script>
// è¨­å®šå€
const LIFF_ID = "2008226975-vWnrprZr";
const WEBHOOK = "https://andywu86627.app.n8n.cloud/webhook/cb884b1c-d8a2-4fd6-bb32-ce3e1278b99c";

const $ = s => document.querySelector(s);
const say = t => $("#msg").innerText = t;

// æ§åˆ¶æŒ‰éˆ•é–å®šç‹€æ…‹
const toggleBtns = (disabled) => {
  $("#btnIn").disabled = disabled;
  $("#btnOut").disabled = disabled;
};

async function run(type) {
  // 1. é–å®šæŒ‰éˆ•ä¸¦é¡¯ç¤ºè¨Šæ¯
  toggleBtns(true);
  const typeText = type === 'CLOCK_IN' ? 'ç°½åˆ°' : 'ç°½é€€';
  say(`æº–å‚™é€²è¡Œ${typeText}æ‰“å¡...`);

  try {
    // 2. LIFF åˆå§‹åŒ–èˆ‡ç™»å…¥æª¢æŸ¥
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { 
      liff.login(); 
      return; 
    }
    const profile = await liff.getProfile();

    // 3. ç²å–å®šä½
    say("å®šä½ä¸­...");
    navigator.geolocation.getCurrentPosition(async pos => {
      say(`å®šä½æˆåŠŸï¼Œè³‡æ–™ä¸Šå‚³ä¸­ (${typeText})...`);
      
      // 4. æº–å‚™å‚³é€è³‡æ–™
      const payload = {
        userId: profile.userId,
        displayName: profile.displayName,
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        ts: new Date().toISOString(),
        type: type 
      };

      try {
        // 5. ç™¼é€è‡³ n8n Webhook
        const r = await fetch(WEBHOOK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        
        // âš ï¸ é€™è£¡è¦é…åˆ n8n å›å‚³çš„æ ¼å¼ï¼Œå‡è¨­ n8n å›å‚³ { status: "success", msg: "..." }
        const data = await r.json();
        
        // --- ğŸ”¥ é—œéµä¿®æ”¹é–‹å§‹ ğŸ”¥ ---
        if (data.status === 'success' || data.ok === true) {
          say(`âœ… ${typeText}æˆåŠŸï¼æ­£åœ¨ç™¼é€é€šçŸ¥...`);

          // ä½¿ç”¨ liff.sendMessages å¹«ä½¿ç”¨è€…åœ¨èŠå¤©å®¤ç™¼è©±
          // é€™æ¨£å°±åƒæ˜¯æ©Ÿå™¨äººå›è¦†ä¸€æ¨£ï¼Œä½†æ˜¯å…è²»çš„ï¼
          liff.sendMessages([
            {
              type: 'text',
              text: data.msg || `${typeText}æˆåŠŸï¼` // å„ªå…ˆé¡¯ç¤º n8n ç®—å¥½çš„è©³ç´°å…§å®¹
            }
          ])
          .then(() => {
            console.log("Message sent");
            liff.closeWindow(); // ç™¼é€å®Œå¾Œé—œé–‰è¦–çª—
          })
          .catch((err) => {
            console.error("ç™¼é€è¨Šæ¯å¤±æ•—:", err);
            // è¬ä¸€ä½¿ç”¨è€…å°é–æ©Ÿå™¨äººæˆ–ç™¼ç”ŸéŒ¯èª¤ï¼Œè‡³å°‘ç•«é¢ä¸Šé¡¯ç¤ºæˆåŠŸ
            say(`âœ… ${typeText}æˆåŠŸï¼(ä½†è¨Šæ¯ç™¼é€å¤±æ•—)`);
            setTimeout(() => liff.closeWindow(), 3000);
          });

        } else {
          // æ‰“å¡å¤±æ•— (ä¾‹å¦‚è·é›¢å¤ªé )
          // é€™è£¡ä¹Ÿå¯ä»¥é¸æ“‡è¦ä¸è¦ç™¼é€å¤±æ•—è¨Šæ¯åˆ°èŠå¤©å®¤ï¼Œé€šå¸¸å¤±æ•—åƒ…é¡¯ç¤ºåœ¨ç•«é¢å³å¯
          say(`âŒ ${data.msg || 'æ‰“å¡å¤±æ•—'}`);
          toggleBtns(false); 
        }
        // --- ğŸ”¥ é—œéµä¿®æ”¹çµæŸ ğŸ”¥ ---

      } catch (e) {
        console.error(e);
        say("âš ï¸ ä¼ºæœå™¨é€£ç·šéŒ¯èª¤");
        toggleBtns(false);
      }
    }, err => {
      console.error(err);
      say("âŒ ç„¡æ³•å–å¾—å®šä½ï¼Œè«‹ç¢ºèªæ¬Šé™");
      toggleBtns(false);
    }, { enableHighAccuracy: true, timeout: 12000 });

  } catch (err) {
    console.error(err);
    say("âš ï¸ åˆå§‹åŒ–å¤±æ•—");
    toggleBtns(false);
  }
}

// ç¶å®šé»æ“Šäº‹ä»¶
$("#btnIn").onclick = () => run('CLOCK_IN');
$("#btnOut").onclick = () => run('CLOCK_OUT');

// ç¶å®šé»æ“Šäº‹ä»¶
$("#btnIn").onclick = () => run('CLOCK_IN');
$("#btnOut").onclick = () => run('CLOCK_OUT');
</script>
</html>
