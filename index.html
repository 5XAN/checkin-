<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>志工打卡系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #4A90E2;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --bg-color: #f4f7f6;
    }

    /* 關鍵修正 1: 允許頁面捲動，並確保背景填滿 */
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: var(--bg-color);
      display: flex;
      justify-content: center;
      align-items: flex-start; /* 讓內容從頂部開始，防止大字體時頭部消失 */
      min-height: 100vh;
      margin: 0;
      color: #333;
      overflow-y: auto; /* 允許垂直捲動 */
      -webkit-overflow-scrolling: touch;
    }

    /* 關鍵修正 2: 增加上下邊距，防止大字體貼邊 */
    .card {
      background: white;
      width: 90%;
      max-width: 380px;
      margin: 30px 15px; 
      padding: 30px 20px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      text-align: center;
      box-sizing: border-box;
      flex-shrink: 0;
    }

    .header-icon {
      font-size: 48px;
      color: var(--primary-color);
      margin-bottom: 15px;
      background: #eef5ff;
      width: 85px;
      height: 85px;
      line-height: 85px;
      border-radius: 50%;
      display: inline-block;
    }

    h2 { 
      margin: 10px 0 8px; 
      font-size: 1.6rem; /* 使用 rem 單位適應縮放 */
      color: #2c3e50; 
      line-height: 1.3;
    }

    p.subtitle { 
      color: #7f8c8d; 
      font-size: 1rem; 
      margin-bottom: 30px; 
      line-height: 1.4;
    }
    
    .btn-group { 
      display: flex; 
      flex-direction: column; 
      gap: 20px; 
    }

    /* 關鍵修正 3: 增加按鈕高度與字體大小，適合長輩點擊 */
    .btn {
      position: relative; 
      border: none; 
      padding: 18px 15px; 
      border-radius: 15px;
      font-size: 1.2rem; 
      font-weight: 700; 
      cursor: pointer; 
      display: flex;
      align-items: center; 
      justify-content: center; 
      gap: 12px;
      transition: all 0.2s; 
      color: white; 
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);
      min-height: 64px; /* 強制最小高度 */
    }

    .btn:active { transform: scale(0.96); }
    .btn:disabled { background: #bdc3c7 !important; cursor: not-allowed; box-shadow: none; }
    .btn-in { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .btn-out { background: linear-gradient(135deg, #f39c12, #e67e22); }
    
    .spinner {
      display: none; width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .footer { margin-top: 30px; font-size: 14px; color: #bdc3c7; }

    /* ========== SweetAlert2 長輩友善調整 ========== */
    div.swal2-popup {
      width: 300px !important;
      padding: 15px !important;
      border-radius: 15px !important;
    }
    div.swal2-title { font-size: 1.4rem !important; }
    div.swal2-html-container { font-size: 1.1rem !important; }
    button.swal2-confirm { font-size: 1rem !important; padding: 10px 30px !important; }
  </style>
</head>
<body>

  <div class="card">
    <div class="header-icon">
      <i class="fa-solid fa-location-dot"></i>
    </div>
    <h2>志工打卡系統</h2>
    <p class="subtitle">請按下方的按鈕進行簽到或簽退</p>

    <div class="btn-group">
      <button id="btnIn" class="btn btn-in" onclick="run('CLOCK_IN')">
        <i class="fa-solid fa-right-to-bracket"></i>
        <span>志工簽到</span>
        <div class="spinner"></div>
      </button>

      <button id="btnOut" class="btn btn-out" onclick="run('CLOCK_OUT')">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span>志工簽退</span>
        <div class="spinner"></div>
      </button>
    </div>

    <div class="footer">
      系統維護：包富良食<br>
      Powered by LIFF & n8n
    </div>
  </div>

  <script>
    // ================= 設定區 =================
    const LIFF_ID = "2008226975-vWnrprZr"; 
    const WEBHOOK = "https://andywu86627.app.n8n.cloud/webhook/cb884b1c-d8a2-4fd6-bb32-ce3e1278b99c"; 
    // =========================================

    // 初始化 LIFF
    document.addEventListener("DOMContentLoaded", function() {
      liff.init({ liffId: LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
        }
      }).catch(err => {
        console.error('LIFF Init Error', err);
        Swal.fire('系統錯誤', '請關閉後重新開啟', 'error');
      });
    });

    // 動畫控制
    const toggleLoading = (btnId, isLoading) => {
      const btn = document.getElementById(btnId);
      const spinner = btn.querySelector('.spinner');
      const icon = btn.querySelector('i');
      const text = btn.querySelector('span');
      const allBtns = document.querySelectorAll('.btn');

      if (isLoading) {
        allBtns.forEach(b => b.disabled = true);
        spinner.style.display = 'block';
        icon.style.display = 'none';
        text.innerText = '處理中...';
      } else {
        allBtns.forEach(b => b.disabled = false);
        spinner.style.display = 'none';
        icon.style.display = 'inline-block';
        text.innerText = btnId === 'btnIn' ? '志工簽到' : '志工簽退';
      }
    };

    async function run(type) {
      const btnId = type === 'CLOCK_IN' ? 'btnIn' : 'btnOut';
      
      toggleLoading(btnId, true);

      // 檢查 GPS 權限與獲取定位
      navigator.geolocation.getCurrentPosition(async pos => {
        try {
          const profile = await liff.getProfile();
          const payload = {
            userId: profile.userId,
            displayName: profile.displayName,
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            ts: new Date().toISOString(),
            type: type
          };

          const response = await fetch(WEBHOOK, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await response.json();

          if (data.status === 'success' || data.ok === true) {
            const isCheckIn = (data.type || type) === 'CLOCK_IN';
            const titleText = isCheckIn ? '簽到成功！' : '簽退成功！';
            const confirmColor = isCheckIn ? '#2ecc71' : '#f39c12';

            // 嘗試在 LINE 傳送文字訊息
            if (liff.isInClient()) {
              try {
                await liff.sendMessages([{
                  type: 'text',
                  text: data.msg || titleText
                }]);
              } catch (e) { console.log("訊息發送受阻"); }
            }

            await Swal.fire({
              icon: 'success',
              title: titleText,
              html: (data.msg || '操作已完成').replace(/\n/g, '<br>'), 
              confirmButtonColor: confirmColor,
              confirmButtonText: '好了'
            });

            liff.closeWindow();

          } else {
            Swal.fire({
              icon: 'error',
              title: '打卡失敗',
              html: (data.msg || '請洽管理員').replace(/\n/g, '<br>'),
              confirmButtonColor: '#e74c3c'
            });
          }
        } catch (err) {
          Swal.fire('連線錯誤', '請檢查網路狀態', 'error');
        } finally {
          toggleLoading(btnId, false);
        }

      }, (geoErr) => {
        let errorMsg = '請開啟手機的 GPS 定位功能';
        if (geoErr.code === 1) errorMsg = '請允許瀏覽器使用定位權限';
        Swal.fire('定位失敗', errorMsg, 'warning');
        toggleLoading(btnId, false);
      }, { enableHighAccuracy: true, timeout: 10000 });
    }
  </script>
</body>
</html>
