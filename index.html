<!doctype html>
<html lang="zh-Hant">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ‰“å¡å ±åˆ°</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;margin:0;padding:24px}
  .wrap{max-width:420px;margin:0 auto;text-align:center}
  button{width:100%;font-size:18px;padding:14px 16px;border:0;border-radius:12px}
  .primary{background:#06C755;color:#fff}
  .msg{margin-top:14px;line-height:1.6}
</style>
<div class="wrap">
  <h2>æ‰“å¡å ±åˆ°</h2>
  <p>æŒ‰ä¸‹æ–¹æŒ‰éˆ•ï¼Œå…è¨±å®šä½å¾Œå°‡è‡ªå‹•å®Œæˆæ‰“å¡ã€‚</p>
  <button id="btn" class="primary">åŒæ„ä¸¦æ‰“å¡</button>
  <div id="msg" class="msg"></div>
</div>
<script>
<script>
const LIFF_ID = "2008217574-rvWBMzGd";                          // ä½ çš„ LIFF ID
const WEBHOOK = "https://andywu86627.app.n8n.cloud/webhook/checkin-liff"; // n8n Production Webhook URL

// --------- å°å·¥å…·ï¼šæŠŠè¨Šæ¯é¡¯ç¤ºåœ¨é é¢ä¸Š ----------
const $ = s => document.querySelector(s);
function log(msg){ const el=$("#msg"); el.innerText = (el.innerText ? el.innerText+"\n" : "") + msg; }
window.onerror = (m,s,l,c,e)=>{ log(`âŒ JSéŒ¯èª¤ï¼š${m}`); if(e&&e.stack) log(e.stack); };

// ç­‰ DOM æº–å‚™å¥½å†ç¶å®šï¼ˆé¿å…æŸäº›è¼‰å…¥æ™‚åºå•é¡Œï¼‰
window.addEventListener('DOMContentLoaded', () => {
  const btn = $("#btn");
  if (!btn) { log("âŒ æ‰¾ä¸åˆ°æŒ‰éˆ• #btn"); return; }
  btn.addEventListener('click', run, { passive:true });
  log("âœ… æŒ‰éˆ•å·²ç¶å®šï¼Œé»æ“Šé–‹å§‹");
});

async function safeJson(res){
  const ct = res.headers.get('content-type') || '';
  if (ct.includes('application/json')) return res.json();
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { ok: res.ok, status: res.status, text }; }
}

async function run(){
  const btn = $("#btn");
  btn.disabled = true;
  log("ğŸ”µ åˆå§‹åŒ– LIFFâ€¦");
  try {
    await liff.init({ liffId: LIFF_ID });
  } catch(e){
    log("âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼ˆæª¢æŸ¥ LIFF_ID èˆ‡ Endpoint URL æ˜¯å¦ä¸€è‡´ï¼‰");
    btn.disabled = false; return;
  }

  if (!liff.isLoggedIn()) {
    log("ğŸ” è½‰è·³ LIFF ç™»å…¥â€¦");
    liff.login();
    return;
  }

  let profile;
  try{
    log("ğŸ”µ å–å¾—ä½¿ç”¨è€…è³‡æ–™â€¦");
    profile = await liff.getProfile();
    log(`âœ… ä½¿ç”¨è€…ï¼š${profile.displayName || profile.userId}`);
  }catch(e){
    log("âš ï¸ å–ä¸åˆ° profileï¼Œæ”¹ç‚ºåŒ¿åé€å‡º");
    profile = { userId: null, displayName: null };
  }

  log("ğŸ“ è«‹å…è¨±å®šä½â€¦");
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    log(`âœ… å®šä½å®Œæˆï¼š${lat.toFixed(5)}, ${lng.toFixed(5)}`);
    log("ğŸš€ é€å‡ºè‡³å¾Œç«¯â€¦");

    // åš´æ ¼ JSONï¼ˆæœƒè§¸ç™¼ CORS é æª¢ï¼›n8n å¿…é ˆæ­£ç¢ºè™•ç† OPTIONS ä¸¦å› CORS æ¨™é ­ï¼‰
    const payload = {
      userId: profile.userId,
      displayName: profile.displayName,
      lat, lng,
      ts: new Date().toISOString()
    };

    try{
      const r = await fetch(WEBHOOK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await safeJson(r);

      if (!r.ok){
        log(`âŒ å¾Œç«¯å›æ‡‰éŒ¯èª¤ HTTP ${r.status} ${data.text||''}`);
        $("#btn").disabled = false; return;
      }

      log("âœ… å¾Œç«¯å·²å›æ‡‰");
      log(data.ok ? `ğŸ æ‰“å¡æˆåŠŸï¼ˆè·é›¢ ${data.distance_m}mï¼‰` : `âŒ ${data.msg || 'æœªé€šé'}`);
      setTimeout(()=>{ try{ liff.closeWindow(); }catch(e){} }, 1200);
    }catch(e){
      log(`âš ï¸ é€å‡ºå¤±æ•—ï¼š${e.message||e}`);
      log("ğŸ‘‰ å¤šåŠæ˜¯ CORS / n8n æœªè™•ç† OPTIONS æˆ–ä½¿ç”¨äº† Test URL");
      $("#btn").disabled = false;
    }
  }, err=>{
    log(`âŒ å®šä½å¤±æ•—ï¼š${err.message||err}`);
    $("#btn").disabled = false;
  }, { enableHighAccuracy:true, timeout:12000 });
}
</script>

</script>
</html>
