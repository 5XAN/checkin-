<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å¿—å·¥æ‰“å¡ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #4A90E2;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --bg-color: #f4f7f6;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: var(--bg-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      color: #333;
      /* é˜²æ­¢èƒŒæ™¯è¢«å½ˆçª—æ’é–‹ */
      overflow: hidden; 
    }

    .card {
      background: white;
      width: 85%; /* æ”¹æˆç™¾åˆ†æ¯”ï¼Œé©æ‡‰å„ç¨®æ‰‹æ©Ÿ */
      max-width: 360px; /* ç¨å¾®ç¸®å°æœ€å¤§å¯¬åº¦ */
      padding: 25px 20px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      text-align: center;
      transition: transform 0.3s;
    }

    /* ... ä¸­é–“çš„æŒ‰éˆ•æ¨£å¼ä¿æŒä¸è®Š ... */
    .header-icon {
      font-size: 48px;
      color: var(--primary-color);
      margin-bottom: 15px;
      background: #eef5ff;
      width: 80px;
      height: 80px;
      line-height: 80px;
      border-radius: 50%;
      display: inline-block;
    }
    h2 { margin: 10px 0 5px; font-size: 22px; color: #2c3e50; }
    p.subtitle { color: #7f8c8d; font-size: 14px; margin-bottom: 25px; }
    
    .btn-group { display: flex; flex-direction: column; gap: 15px; }

    .btn {
      position: relative; border: none; padding: 15px; border-radius: 12px;
      font-size: 16px; font-weight: 700; cursor: pointer; display: flex;
      align-items: center; justify-content: center; gap: 10px;
      transition: all 0.2s; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { background: #bdc3c7 !important; cursor: not-allowed; box-shadow: none; }
    .btn-in { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .btn-out { background: linear-gradient(135deg, #f39c12, #e67e22); }
    
    .spinner {
      display: none; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .footer { margin-top: 25px; font-size: 12px; color: #bdc3c7; }

   /* ========== ğŸ”¥ ä¿®æ­£ç‰ˆï¼šç¸®å° SweetAlert2 (å®Œç¾æ¯”ä¾‹) ğŸ”¥ ========== */
    
    /* 1. å½ˆçª—å®¹å™¨è¨­å®š */
    div.swal2-popup {
      width: 280px !important;   /* æ‰‹æ©Ÿå¯¬åº¦å‰›å¥½ */
      padding: 15px !important;  /* æ¸›å°‘å…§è· */
    }

    /* 2. æ¨™é¡Œèˆ‡æ–‡å­—èª¿æ•´ */
    div.swal2-title {
      font-size: 1.25rem !important;
      margin-top: 10px !important;
    }
    div.swal2-html-container {
      font-size: 0.9rem !important;
      margin: 5px 0 15px !important;
    }

    /* 3.ã€é—œéµã€‘åœ–ç¤ºç¸®å°è¡“ */
    /* ä½¿ç”¨ transform: scale() å¯ä»¥å®Œç¾ç¸®å°åœ–ç¤ºï¼Œä¸æœƒè®“å‹¾å‹¾æ­ªæ‰ */
    div.swal2-icon {
      transform: scale(1); /* ç¸®å°åˆ° 60% */
      margin-top: 5px !important;    /* èª¿æ•´ä¸Šæ–¹é–“è· */
      margin-bottom: -10px !important; /* å› ç‚ºç¸®å°äº†ï¼ŒæŠŠä¸‹æ–¹å…§å®¹æ‹‰è¿‘ä¸€é» */
    }
    
    /* ç§»é™¤æ‰€æœ‰å°å…§éƒ¨ç·šæ¢çš„æ‰‹å‹•ä¿®æ­£ï¼Œè®“å®ƒæ¢å¾©åŸå» è¨­å®šçš„å®Œç¾ä½ç½® */
    div.swal2-icon .swal2-success-line-tip,
    div.swal2-icon .swal2-success-line-long, 
    div.swal2-icon .swal2-success-ring {
      top: auto !important;
      width: auto !important;
      height: auto !important;
    }

    /* 4. æŒ‰éˆ•å¾®èª¿ */
    div.swal2-actions {
      margin-top: 5px !important;
    }
    button.swal2-confirm {
      font-size: 14px !important;
      padding: 8px 25px !important;
      border-radius: 8px !important;
    }
  </style>
</head>
<body>

  <div class="card">
    <div class="header-icon">
      <i class="fa-solid fa-location-dot"></i>
    </div>
    <h2>å¿—å·¥æ‰“å¡ç³»çµ±</h2>
    <p class="subtitle">è«‹é¸æ“‡æ‚¨çš„æ‰“å¡é …ç›®ï¼Œç³»çµ±å°‡è‡ªå‹•å®šä½</p>

    <div class="btn-group">
      <button id="btnIn" class="btn btn-in" onclick="run('CLOCK_IN')">
        <i class="fa-solid fa-right-to-bracket"></i>
        <span>å¿—å·¥ç°½åˆ°</span>
        <div class="spinner"></div>
      </button>

      <button id="btnOut" class="btn btn-out" onclick="run('CLOCK_OUT')">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span>å¿—å·¥ç°½é€€</span>
        <div class="spinner"></div>
      </button>
    </div>

    <div class="footer">
      Powered by LIFF & n8n
    </div>
  </div>

  <script>
    // ================= è¨­å®šå€ =================
    const LIFF_ID = "2008226975-vWnrprZr"; 
    const WEBHOOK = "https://andywu86627.app.n8n.cloud/webhook/cb884b1c-d8a2-4fd6-bb32-ce3e1278b99c"; 
    // =========================================

    // åˆå§‹åŒ– LIFF
    document.addEventListener("DOMContentLoaded", function() {
      liff.init({ liffId: LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
        }
      }).catch(err => {
        console.error('LIFF Init Error', err);
        Swal.fire('éŒ¯èª¤', 'LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ ID', 'error');
      });
    });

    // æŒ‰éˆ•é–å®šèˆ‡å‹•ç•«æ§åˆ¶
    const toggleLoading = (btnId, isLoading) => {
      const btn = document.getElementById(btnId);
      const spinner = btn.querySelector('.spinner');
      const icon = btn.querySelector('i');
      const text = btn.querySelector('span');
      const allBtns = document.querySelectorAll('.btn');

      if (isLoading) {
        allBtns.forEach(b => b.disabled = true); // é–å®šæ‰€æœ‰æŒ‰éˆ•
        spinner.style.display = 'block';
        icon.style.display = 'none';
        text.innerText = 'è™•ç†ä¸­...';
      } else {
        allBtns.forEach(b => b.disabled = false); // è§£é–
        spinner.style.display = 'none';
        icon.style.display = 'inline-block';
        text.innerText = btnId === 'btnIn' ? 'å¿—å·¥ç°½åˆ°' : 'å¿—å·¥ç°½é€€';
      }
    };

    async function run(type) {
      const btnId = type === 'CLOCK_IN' ? 'btnIn' : 'btnOut';
      const typeText = type === 'CLOCK_IN' ? 'ç°½åˆ°' : 'ç°½é€€';

      // 1. é–‹å§‹ Loading
      toggleLoading(btnId, true);

      try {
        // 2. ç²å–å®šä½
        navigator.geolocation.getCurrentPosition(async pos => {
          
          const profile = await liff.getProfile();
          const payload = {
            userId: profile.userId,
            displayName: profile.displayName,
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            ts: new Date().toISOString(),
            type: type
          };

          // 3. ç™¼é€çµ¦ n8n
          try {
            const response = await fetch(WEBHOOK, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });

            const data = await response.json();

            // 4. åˆ¤æ–· n8n å›å‚³çµæœ
            if (data.status === 'success' || data.ok === true) {
              
              // æ ¹æ“šå›å‚³çš„ type æ±ºå®šå½ˆçª—é¡è‰²å’Œåœ–ç¤º (å¾Œç«¯å›å‚³ type: CLOCK_IN æˆ– CLOCK_OUT)
              // å¦‚æœå¾Œç«¯æ²’å›å‚³ï¼Œå°±ç”¨å‰ç«¯åŸæœ¬çš„ type è®Šæ•¸
              const actionType = data.type || type; 
              const isCheckIn = actionType === 'CLOCK_IN';
              
              // è¨­å®šå½ˆçª—æ¨£å¼
              const titleText = isCheckIn ? 'ç°½åˆ°æˆåŠŸï¼' : 'ç°½é€€æˆåŠŸï¼';
              const popupIcon = isCheckIn ? 'success' : 'success'; // ä¹Ÿå¯ä»¥æ›æˆ 'info'
              const confirmColor = isCheckIn ? '#2ecc71' : '#f39c12'; // ç¶ è‰² vs æ©˜è‰²

              // å˜—è©¦ç™¼é€ LINE èŠå¤©å®¤è¨Šæ¯
              let notifyMsg = "";
              try {
                if (liff.isInClient()) {
                  await liff.sendMessages([{
                    type: 'text',
                    text: data.msg || `${titleText}`
                  }]);
                }
              } catch (msgErr) {
                console.warn("ç™¼é€è¨Šæ¯å¤±æ•—", msgErr);
              }

              // é¡¯ç¤ºå·®ç•°åŒ–çš„æ¼‚äº®å½ˆçª—
              await Swal.fire({
                icon: popupIcon,
                title: titleText,
                // ç›´æ¥é¡¯ç¤º n8n å‚³å›ä¾†çš„å®¢è£½åŒ– msg (æ—©å®‰ vs è¾›è‹¦äº†)
                // é€™è£¡ç”¨ replace æŠŠæ›è¡Œç¬¦è™Ÿ \n è½‰æˆ HTML çš„ <br> è®“æ’ç‰ˆæ›´æ¼‚äº®
                html: (data.msg || '').replace(/\n/g, '<br>'), 
                confirmButtonColor: confirmColor,
                confirmButtonText: 'é—œé–‰'
              });

              liff.closeWindow();

            } else {
              // æ‰“å¡å¤±æ•— (ä¾‹å¦‚è·é›¢å¤ªé )
              Swal.fire({
                icon: 'error',
                title: 'æ‰“å¡å¤±æ•—',
                text: data.msg || 'æœªçŸ¥éŒ¯èª¤',
                confirmButtonColor: '#e74c3c'
              });
            }

          } catch (fetchErr) {
            console.error(fetchErr);
            Swal.fire('ä¼ºæœå™¨éŒ¯èª¤', 'ç„¡æ³•é€£æ¥åˆ°æ‰“å¡ä¼ºæœå™¨', 'error');
          } finally {
            toggleLoading(btnId, false);
          }

        }, (geoErr) => {
          console.error(geoErr);
          Swal.fire('å®šä½å¤±æ•—', 'è«‹ç¢ºèªæ‚¨å·²æˆæ¬Š GPS å®šä½åŠŸèƒ½', 'warning');
          toggleLoading(btnId, false);
        }, { enableHighAccuracy: true, timeout: 10000 });

      } catch (err) {
        console.error(err);
        Swal.fire('éŒ¯èª¤', 'ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤', 'error');
        toggleLoading(btnId, false);
      }
    }
  </script>
</body>
</html>
