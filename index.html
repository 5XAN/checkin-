// 設定區
const LIFF_ID = "2008226975-vWnrprZr";
const WEBHOOK = "https://andywu86627.app.n8n.cloud/webhook/cb884b1c-d8a2-4fd6-bb32-ce3e1278b99c";

const $ = s => document.querySelector(s);
const say = t => $("#msg").innerText = t;

// 控制按鈕鎖定狀態
const toggleBtns = (disabled) => {
  $("#btnIn").disabled = disabled;
  $("#btnOut").disabled = disabled;
};

async function run(type) {
  // 1. 鎖定按鈕並顯示訊息
  toggleBtns(true);
  const typeText = type === 'CLOCK_IN' ? '簽到' : '簽退';
  say(`準備進行${typeText}打卡...`);

  try {
    // 2. LIFF 初始化與登入檢查
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { 
      liff.login(); 
      return; 
    }
    const profile = await liff.getProfile();

    // 3. 獲取定位
    say("定位中...");
    navigator.geolocation.getCurrentPosition(async pos => {
      say(`定位成功，資料上傳中 (${typeText})...`);
      
      // 4. 準備傳送資料
      const payload = {
        userId: profile.userId,
        displayName: profile.displayName,
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        ts: new Date().toISOString(),
        type: type 
      };

      try {
        // 5. 發送至 n8n Webhook
        const r = await fetch(WEBHOOK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        
        // ⚠️ 這裡要配合 n8n 回傳的格式，假設 n8n 回傳 { status: "success", msg: "..." }
        const data = await r.json();
        
        // ---  改成liff網頁回傳打卡結果 ---
        if (data.status === 'success' || data.ok === true) {
          say(`✅ ${typeText}成功！正在發送通知...`);

          // 使用 liff.sendMessages 幫使用者在聊天室發話
          // 這樣就像是機器人回覆一樣，但是免費的！
          liff.sendMessages([
            {
              type: 'text',
              text: data.msg || `${typeText}成功！` // 優先顯示 n8n 算好的詳細內容
            }
          ])
          .then(() => {
            console.log("Message sent");
            liff.closeWindow(); // 發送完後關閉視窗
          })
          .catch((err) => {
            console.error("發送訊息失敗:", err);
            // 萬一使用者封鎖機器人或發生錯誤，至少畫面上顯示成功
            say(`✅ ${typeText}成功！(但訊息發送失敗)`);
            setTimeout(() => liff.closeWindow(), 3000);
          });

        } else {
          // 打卡失敗 (例如距離太遠)
          // 這裡也可以選擇要不要發送失敗訊息到聊天室，通常失敗僅顯示在畫面即可
          say(`❌ ${data.msg || '打卡失敗'}`);
          toggleBtns(false); 
        }
        // ---  修改結束  ---

      } catch (e) {
        console.error(e);
        say("⚠️ 伺服器連線錯誤");
        toggleBtns(false);
      }
    }, err => {
      console.error(err);
      say("❌ 無法取得定位，請確認權限");
      toggleBtns(false);
    }, { enableHighAccuracy: true, timeout: 12000 });

  } catch (err) {
    console.error(err);
    say("⚠️ 初始化失敗");
    toggleBtns(false);
  }
}

// 綁定點擊事件
$("#btnIn").onclick = () => run('CLOCK_IN');
$("#btnOut").onclick = () => run('CLOCK_OUT');
