<!doctype html>
<html lang="zh-Hant">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>打卡系統</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto; margin: 0; padding: 24px; background-color: #f8f9fa; }
  .wrap { max-width: 420px; margin: 0 auto; text-align: center; background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  h2 { margin-top: 0; color: #333; }
  p { color: #666; font-size: 14px; margin-bottom: 24px; }
  
  /* 按鈕容器：讓按鈕並排 */
  .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  
  button { width: 100%; font-size: 16px; padding: 14px 0; border: 0; border-radius: 12px; cursor: pointer; transition: opacity 0.2s; font-weight: bold; color: #fff; }
  button:active { opacity: 0.8; }
  button:disabled { background: #ccc !important; cursor: not-allowed; }

  /* 不同顏色的按鈕 */
  .btn-in { background: #06C755; } /* LINE 綠 */
  .btn-out { background: #ff9800; } /* 橘色 */

  .msg { margin-top: 20px; line-height: 1.6; font-size: 15px; min-height: 24px; }
</style>

<div class="wrap">
  <h2>打卡</h2>
  <p>請選擇打卡類型，系統將自動擷取定位。</p>
  
  <div class="btn-group">
    <button id="btnIn" class="btn-in">志工簽到</button>
    <button id="btnOut" class="btn-out">志工簽退</button>
  </div>
  
  <div id="msg" class="msg"></div>
</div>

<script>
// 設定區
const LIFF_ID = "2008226975-vWnrprZr";
const WEBHOOK = "https://andywu86627.app.n8n.cloud/webhook/cb884b1c-d8a2-4fd6-bb32-ce3e1278b99c";

const $ = s => document.querySelector(s);
const say = t => $("#msg").innerText = t;

// 控制按鈕鎖定狀態
const toggleBtns = (disabled) => {
  $("#btnIn").disabled = disabled;
  $("#btnOut").disabled = disabled;
};

async function run(type) {
  // 1. 鎖定按鈕並顯示訊息
  toggleBtns(true);
  const typeText = type === 'CLOCK_IN' ? '簽到' : '簽退';
  say(`準備進行${typeText}打卡...`);

  try {
    // 2. LIFF 初始化與登入檢查
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { 
      liff.login(); 
      return; 
    }
    const profile = await liff.getProfile();

    // 3. 獲取定位
    say("定位中...");
    navigator.geolocation.getCurrentPosition(async pos => {
      say(`定位成功，資料上傳中 (${typeText})...`);
      
      // 4. 準備傳送資料 (新增了 type 欄位)
      const payload = {
        userId: profile.userId,
        displayName: profile.displayName,
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        ts: new Date().toISOString(),
        type: type // 傳送打卡類型 (CLOCK_IN 或 CLOCK_OUT)
      };

      try {
        // 5. 發送至 n8n Webhook
        const r = await fetch(WEBHOOK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        
        const data = await r.json();
        
        if (data.ok) {
          say(`✅ ${typeText}成功！\n(距離 ${data.distance_m}m)`);
          setTimeout(() => { try { liff.closeWindow(); } catch (e) {} }, 3000);
        } else {
          say(`❌ ${data.msg || '打卡失敗'}`);
          toggleBtns(false); // 失敗時解鎖按鈕讓使用者重試
        }
      } catch (e) {
        console.error(e);
        say("⚠️ 伺服器連線錯誤");
        toggleBtns(false);
      }
    }, err => {
      console.error(err);
      say("❌ 無法取得定位，請確認權限");
      toggleBtns(false);
    }, { enableHighAccuracy: true, timeout: 12000 });

  } catch (err) {
    console.error(err);
    say("⚠️ 初始化失敗");
    toggleBtns(false);
  }
}

// 綁定點擊事件
$("#btnIn").onclick = () => run('CLOCK_IN');
$("#btnOut").onclick = () => run('CLOCK_OUT');
</script>
</html>
